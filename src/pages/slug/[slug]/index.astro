---
export const prerender = false;

import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import RecommendationCard from '../../../components/RecommendationCard.astro';
import ProgressBar from '../../../components/ProgressBar.astro';
import { supabase } from '../../../lib/supabase';
import type { Slug, RecommendationDetail, AnalysisProgress } from '../../../lib/types';
import { marked } from 'marked';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Fetch slug info
const { data: slugData, error: slugError } = await supabase
  .from('Slugs')
  .select('*')
  .eq('slug', slug)
  .single();

if (slugError || !slugData) {
  return Astro.redirect('/');
}

const slugInfo: Slug = slugData;

// Fetch recommendations with sections and tickets
const { data: recommendations, error: recError } = await supabase
  .from('kb_recommendations')
  .select(`
    *,
    sections:kb_recommendation_sections(*),
    source_tickets:kb_recommendation_tickets(*)
  `)
  .eq('slug', slug)
  .order('priority', { ascending: false });

const recommendationDetails: RecommendationDetail[] = (recommendations || []).map((rec: any) => ({
  ...rec,
  sections: rec.sections || [],
  source_tickets: rec.source_tickets || []
}));

// Fetch analysis progress
const { data: progressData } = await supabase
  .from('slug_analysis_progress')
  .select('*')
  .eq('slug', slug)
  .single();

const progress: AnalysisProgress | null = progressData;

// Calculate stats
const totalRecommendations = recommendationDetails.length;
const highPriority = recommendationDetails.filter(r => r.priority === 'high').length;
const totalSections = recommendationDetails.reduce((acc, r) => acc + r.sections.length, 0);
const totalTickets = recommendationDetails.reduce((acc, r) => acc + r.source_tickets.length, 0);
---

<Layout title={`${slug} - KB Recommendations`}>
  <Header />

  <main class="max-w-3xl mx-auto px-6">
    <!-- Back Button -->
    <div class="mb-6">
      <a
        href="/"
        class="inline-flex items-center justify-center px-4 py-2 bg-transparent hover:bg-gray-100 rounded-md text-sm font-medium transition-colors"
      >
        ‚Üê Back to All Slugs
      </a>
    </div>

    <!-- Slug Header -->
    <div class="mb-8">
      <div class="flex items-center gap-4 mb-4 flex-wrap">
        <h1 class="text-4xl font-semibold tracking-tight">{slug}</h1>
        {slugInfo.match && (
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-50 text-green-600">
            Has KB Docs
          </span>
        )}
        {!slugInfo.match && totalRecommendations > 0 && (
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-50 text-red-600">
            Needs KB Article
          </span>
        )}
      </div>

      <!-- Tab Navigation -->
      <div class="flex gap-1 border-b border-gray-200 mb-6">
        <a
          href={`/slug/${slug}`}
          class="px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600"
        >
          Recommendations
        </a>
        <a
          href={`/slug/${slug}/report`}
          class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-900 hover:border-gray-300 transition-colors"
        >
          Hit/Miss Report
        </a>
      </div>

      {slugInfo.matched_search && (
        <div class="mb-4">
          <span class="text-sm text-gray-500">KB Searches: </span>
          <span class="text-sm font-mono">{slugInfo.matched_search}</span>
        </div>
      )}

      <!-- Summary Stats -->
      <div class="grid grid-cols-[repeat(auto-fit,minmax(150px,1fr))] gap-4 mb-6">
        <div class="p-4 bg-gray-50 rounded-md">
          <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total Tickets</div>
          <div class="text-2xl font-semibold">{slugInfo.ticket_count}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded-md">
          <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Recommendations</div>
          <div class="text-2xl font-semibold">{totalRecommendations}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded-md">
          <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">High Priority</div>
          <div class="text-2xl font-semibold">{highPriority}</div>
        </div>
        <div class="p-4 bg-gray-50 rounded-md">
          <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Sections</div>
          <div class="text-2xl font-semibold">{totalSections}</div>
        </div>
      </div>

      <!-- Progress -->
      {progress && (
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
          <h3 class="text-sm font-medium mb-4">Analysis Progress</h3>
          <ProgressBar
            current={progress.tickets_analyzed}
            total={progress.total_tickets || 0}
          />
          <div class="flex items-center justify-between mt-4 text-sm text-gray-500">
            <span>Status: {progress.status.replace('_', ' ')}</span>
            <span>KB Searches: {progress.kb_searches_performed}</span>
          </div>
          {progress.error_message && (
            <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700">
              {progress.error_message}
            </div>
          )}
        </div>
      )}
    </div>

    <!-- Matched KB Documents -->
    {slugInfo.match && slugInfo.matched_documents && (
      <section class="mb-8">
        <h2 class="text-2xl font-semibold mb-6">‚úÖ Existing KB Documentation</h2>
        <div class="bg-white border border-gray-200 rounded-lg p-6">
          {Array.isArray(slugInfo.matched_documents) && slugInfo.matched_documents.map((doc: any) => (
            <div class="mb-6 pb-6 border-b border-gray-200 last:border-0 last:mb-0 last:pb-0">
              <div class="flex items-start justify-between mb-2">
                <h4 class="font-medium">{doc.name}</h4>
                <span
                  class:list={[
                    'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium',
                    doc.relevance === 'high' ? 'bg-green-50 text-green-600' : 'bg-gray-50 text-gray-500'
                  ]}
                >
                  {doc.relevance}
                </span>
              </div>
              {doc.url && (
                <a href={doc.url} class="text-sm text-blue-600 hover:underline mb-2 block" target="_blank" rel="noopener">
                  View Document ‚Üí
                </a>
              )}
              {doc.reason && (
                <div class="text-sm text-gray-500 mb-2 prose prose-sm max-w-none" set:html={marked.parse(doc.reason, { async: false })} />
              )}
              {doc.coverage_score && (
                <div class="text-xs text-gray-500">Coverage: {doc.coverage_score}/10</div>
              )}
              {doc.gaps && (
                <div class="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded">
                  <div class="text-xs font-medium text-yellow-800 mb-1">Gaps Identified:</div>
                  <div class="text-xs text-yellow-700 prose prose-sm max-w-none" set:html={marked.parse(doc.gaps, { async: false })} />
                </div>
              )}
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- Recommendations -->
    {totalRecommendations > 0 && (
      <section>
        <h2 class="text-2xl font-semibold mb-6">üìù Recommendations ({totalRecommendations})</h2>
        {recommendationDetails
          .sort((a, b) => {
            const priorityOrder = { high: 3, medium: 2, low: 1 };
            return (priorityOrder[b.priority as keyof typeof priorityOrder] || 0) -
                   (priorityOrder[a.priority as keyof typeof priorityOrder] || 0);
          })
          .map((rec) => (
            <RecommendationCard recommendation={rec} />
          ))}
      </section>
    )}

    <!-- Empty State -->
    {!slugInfo.match && totalRecommendations === 0 && (
      <div class="text-center py-16 px-8">
        <div class="text-5xl mb-4 opacity-30">üîç</div>
        <h3 class="text-xl font-semibold mb-2">No recommendations yet</h3>
        <p class="text-gray-500 text-sm">
          Analysis is pending or in progress for this slug
        </p>
      </div>
    )}
  </main>
</Layout>
