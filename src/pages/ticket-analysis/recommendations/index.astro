---
export const prerender = false;

import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import PriorityBadge from '../../../components/PriorityBadge.astro';
import StatusBadge from '../../../components/StatusBadge.astro';
import { supabase } from '../../../lib/supabase';

// Get filter params from URL
const url = new URL(Astro.request.url);
const statusFilter = url.searchParams.get('status') || 'draft';
const priorityFilter = url.searchParams.get('priority') || '';

// Build query
let query = supabase
  .from('ticket_kb_content_recommendations')
  .select(`
    *,
    ticket_kb_content_sections(count)
  `, { count: 'exact' })
  .order('created_at', { ascending: false });

// Apply status filter
if (statusFilter) {
  query = query.eq('status', statusFilter);
}

// Apply priority filter
if (priorityFilter) {
  query = query.eq('priority', priorityFilter);
}

const { data: recommendations, count } = await query;

// Calculate section counts
const recsWithCounts = recommendations?.map(rec => ({
  ...rec,
  section_count: rec.ticket_kb_content_sections?.[0]?.count || 0
})) || [];

// Get all source ticket IDs for the recommendations
const allSourceTicketIds = recommendations?.flatMap(r => r.source_ticket_ids || []) || [];
---

<Layout title="KB Recommendations">
  <Header current="ticket-analysis" />

  <main class="max-w-7xl mx-auto px-6">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center gap-4 mb-2">
        <a href="/ticket-analysis" class="text-sm text-gray-500 hover:text-gray-900">‚Üê Back to Dashboard</a>
      </div>
      <h1 class="text-4xl font-semibold tracking-tight mb-2">KB Recommendations</h1>
      <p class="text-gray-600">Browse all KB article recommendations</p>
    </div>

    <!-- Status Filter Tabs -->
    <div class="flex gap-2 mb-6 border-b border-gray-200">
      <a
        href="/ticket-analysis/recommendations?status=draft"
        class:list={[
          'px-4 py-2 text-sm font-medium border-b-2 transition-colors',
          statusFilter === 'draft' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-900'
        ]}
      >
        Draft
      </a>
      <a
        href="/ticket-analysis/recommendations?status=reviewed"
        class:list={[
          'px-4 py-2 text-sm font-medium border-b-2 transition-colors',
          statusFilter === 'reviewed' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-900'
        ]}
      >
        Reviewed
      </a>
      <a
        href="/ticket-analysis/recommendations?status=approved"
        class:list={[
          'px-4 py-2 text-sm font-medium border-b-2 transition-colors',
          statusFilter === 'approved' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-900'
        ]}
      >
        Approved
      </a>
      <a
        href="/ticket-analysis/recommendations?status=published"
        class:list={[
          'px-4 py-2 text-sm font-medium border-b-2 transition-colors',
          statusFilter === 'published' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-900'
        ]}
      >
        Published
      </a>
    </div>

    <!-- Priority Filter -->
    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
      <form method="get" class="flex flex-wrap gap-4 items-end">
        <input type="hidden" name="status" value={statusFilter} />
        <div class="min-w-[150px]">
          <label for="priority" class="block text-sm font-medium text-gray-700 mb-1">Filter by Priority</label>
          <select
            id="priority"
            name="priority"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="">All Priorities</option>
            <option value="high" selected={priorityFilter === 'high'}>High</option>
            <option value="medium" selected={priorityFilter === 'medium'}>Medium</option>
            <option value="low" selected={priorityFilter === 'low'}>Low</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button
            type="submit"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
          >
            Apply Filter
          </button>
          <a
            href={`/ticket-analysis/recommendations?status=${statusFilter}`}
            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors"
          >
            Clear
          </a>
        </div>
      </form>
    </div>

    <!-- Results Count -->
    <div class="mb-4 text-sm text-gray-600">
      Showing {recsWithCounts.length || 0} {count !== null && `of ${count}`} recommendations
    </div>

    <!-- Data Table -->
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
      {recsWithCounts && recsWithCounts.length > 0 ? (
        <table class="w-full">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Slug</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sections</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {recsWithCounts.map((rec: any) => (
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4">
                  <a href={`/ticket-analysis/recommendations/${rec.id}`} class="text-sm font-medium text-blue-600 hover:underline">
                    {rec.recommendation_title}
                  </a>
                </td>
                <td class="px-6 py-4 text-sm">
                  <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">{rec.slug}</span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-600">
                  {rec.recommendation_type || 'N/A'}
                </td>
                <td class="px-6 py-4">
                  <PriorityBadge priority={rec.priority} />
                </td>
                <td class="px-6 py-4 text-sm text-gray-600 text-center">
                  {rec.section_count}
                </td>
                <td class="px-6 py-4">
                  <StatusBadge status={rec.status} />
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">
                  {new Date(rec.created_at).toLocaleDateString()}
                </td>
                <td class="px-6 py-4">
                  <a
                    href={`/ticket-analysis/recommendations/${rec.id}`}
                    class="text-sm text-blue-600 hover:underline"
                  >
                    View
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      ) : (
        <div class="p-12 text-center">
          <div class="text-4xl mb-4 opacity-30">üìù</div>
          <h3 class="text-lg font-semibold mb-2">No recommendations found</h3>
          <p class="text-gray-600 text-sm">
            {priorityFilter ? 'Try adjusting your filters' : `No ${statusFilter} recommendations yet`}
          </p>
        </div>
      )}
    </div>
  </main>
</Layout>
